Original prompt: добавь Редактор скинов
Цвета змейки/еды/следа, эффекты “неон-пакеты”. Ежедневные челленджи генерируются случайно
Отдельные цели на день: “съешь 20 еды”, “выживи 3 минуты”, награда трофеями. Прокачка змейки
Косметика за трофеи: скины тела, хвоста, эффект поедания, разные типы еды.

- Инициализирован прогресс-файл.
- План: расширить foodRenderer под типы еды/эффекты; добавить меню редактора и магазина; внедрить ежедневные челленджи и прокачку в игровой цикл.
- Расширен foodRenderer: добавлены типы еды (solar/plasma/toxic/void), цветовые конфиги и neonBoost.
- В index.html добавлены меню: редактор скинов и магазин косметики за трофеи.
- Реализованы ежедневные челленджи с генерацией по дате (eat/survive/score), прогрессом, наградами и сохранением.
- Добавлена прокачка змейки (уровень + XP), отображение в HUD/меню и бонус скорости для новых сессий.
- Добавлены косметики за трофеи: скины тела/хвоста, эффекты поедания, типы еды, экипировка и покупка.
- Добавлены визуальные эффекты поедания и неон-пакеты в редакторе.
- Добавлены window.render_game_to_text и window.advanceTime для автотест-клиента.
- Проверка автотестов через Playwright не запущена: в окружении отсутствуют `node` и `npx` (команды не найдены).
- Выполнена ручная статическая проверка вставленных секций в index.html и foodRenderer.js.
- TODO для следующего шага: после установки Node.js прогнать $WEB_GAME_CLIENT со скриншотами и проверить консольные ошибки.
- Мобильная оптимизация UI: добавлены ограничение высоты и прокрутка для меню, переработана адаптивная раскладка HUD/кнопок.
- Добавлен режим `body.menu-active`: при открытых меню скрываются HUD, кнопки управления и exit-кнопка (исключает наложения на мобильных).
- Добавлена функция syncMenuOverlayState() и вызовы во всех переходах между меню/игрой/реплеем.
- На очень узких экранах (<560px) добавлены компактные размеры HUD/кнопок и вертикальная компоновка shop/skin строк.
- Добавлено непрерывное масштабирование UI (`--ui-scale`) от текущих размеров viewport и подписки на resize/orientationchange/visualViewport.
- Меню/HUD/кнопки управления теперь масштабируются пропорционально устройству; canvas ужимается по доступной высоте экрана на маленьких устройствах.
- Добавлен экстремальный компактный режим (`body.extreme-compact`) для очень маленьких экранов.
- В extreme-compact скрываются второстепенные HUD-блоки (ранг, прокачка, рекорд), остаются ключевые (трофеи, счёт, уровень).
- Уменьшены размеры меню/кнопок/челлендж-карточек/виртуальных стрелок в extreme-compact.
- Автовключение extreme-compact добавлено в updateResponsiveScale() при очень малом viewport.
- AI улучшен: увеличен lookahead, добавлен анти-цикл по повтору head+food состояний, fallback по Hamiltonian-прогрессу.
- AI-защита от мгновенной смерти: запрет разворота на 180° (AI теперь учитывает текущий dir), усилена проверка вероятной коллизии.
- Спавн еды обновлён: еда не спавнится в краях/углах (margin=1 клетка) и не спавнится в клетке змейки.
- Mobile landscape фикс: HUD превращается в горизонтальную ленту с прокруткой; кнопки центрируются; canvas ужимается по высоте.
- Для стабильного длинного AI-забега снижена эскалация скорости в AI-режиме: стартовая скорость AI немного ниже, прирост скорости на level-up уменьшен и ограничен сверху.
- Добавлен отдельный модуль фоновой отрисовки: backgroundRenderer.js.
- Реализован оранжевый пульсирующий фон (градиент, пульс-кольца, glow, grid, vignette).
- Подключён в index.html: draw() теперь вызывает renderBackground() перед отрисовкой змейки/еды.
- AI доработан против поведения "от края до края":
  - переписан детектор циклов на основе плотности уникальных состояний и частоты повторов,
  - анти-цикл включается только при достаточной длине змейки,
  - в оценку хода добавлен бонус за безопасную дистанцию от стен,
  - смягчены условия безопасного пути к еде (меньше ложных отказов),
  - усилен приоритет мобилити/пищи в cycle-break выборе.
- AI стабилизирован против лишних действий: добавлены инерция курса и штрафы за частые/маятниковые повороты.
- Добавлена post-decision стабилизация: если прямой ход почти не хуже и безопасен, AI не меняет направление.
- Частота принятия AI-решений снижена (aiInterval 28мс вместо 16мс), чтобы убрать дерганость.
- Исправление залипания AI по краю:
  - ослаблена инерция направления (меньше keepDirectionBonus/penalty/zigzag/switchThreshold),
  - усилен приоритет приближения к еде (moveFoodDistanceWeight увеличен),
  - anti-loop теперь срабатывает позже и реже (только на длинной змейке, более строгий порог),
  - добавлено правило: если поворот заметно лучше приближает к еде, AI не удерживает прямой курс,
  - aiInterval слегка ускорен (22мс) для более оперативного выхода из крайних траекторий.
- Фикс само-ловушек AI:
  - ужесточена проверка безопасного конца пути к еде (убран слишком мягкий критерий),
  - добавлена двухшаговая проверка выхода (hasTwoStepEscape),
  - если выбранный ход ведёт в тупик, AI принудительно выбирает escape-ход с приоритетом пространства/мобилити.
- Доп. анти-ловушка AI: добавлен фильтр trap-safe ходов (двухшаговый выход + хвост/пространство) с обязательной подстановкой безопасного хода, если выбранный не проходит.
- hasTwoStepEscape ужесточён: удалён мягкий критерий nextMobility>=2.
- Добавлен префикс `lvl` рядом с уровнем прокачки: в main menu и в HUD-значении прокачки.
- Улучшен replay: добавлена синхронизация с режимом записи (AI/игрок) для корректного прироста скорости в повторе.
- В replay добавлена валидация направлений (без разворота на 180), чтобы не ломать траекторию.
- Добавлен экспорт одной игры из истории: кнопка "Экспорт игры" в каждой записи.
- Экспорт истории вынесен в общую функцию exportGamesPayload() (поддерживает полный и одиночный экспорт).
- Закрыт фарм прокачки через AI: введён флаг sessionUsedAI и единая проверка isRankedSession().
- Теперь XP/челленджи/трофеи начисляются только в ranked-сессии (игрок, без AI, без replay).
- В историю такие сессии помечаются как AI, если в ходе забега AI использовался хоть раз.
- Удалена косметика самой змейки: убраны поля snakeColor/trailColor/bodySkin/tailSkin, их UI-контролы и товары магазина.
- Редактор/магазин переориентированы на эффекты еды/поедания.
- Отрисовка змейки упрощена до единого неон-стиля без body/tail-скинов.
- Добавлена система мутаций (Фаза, Магнит, Овердрайв):
  - случайный триггер при поедании (только ranked),
  - таймер мутации в HUD,
  - эффекты: проход через тело (Фаза), увеличенный радиус подбора еды (Магнит), ускорение движения (Овердрайв),
  - текущая мутация добавлена в render_game_to_text.
- Сделал ускорение AI заметным: прирост скорости на level-up в AI увеличен до +22 (было +12), лимит AI скорости поднят до 620.
- Стартовая коррекция AI на старте смягчена (-30 вместо -50), чтобы динамика разгона ощущалась раньше.
- Добавлен HUD-индикатор текущей скорости (`СКОРОСТЬ`) и обновление в ключевых точках (init/level-up/start/replay).
- Скрыто отображение уровня и прокачки в UI (HUD + main menu), без удаления внутренней механики.
- Исправлен цвет цифр скорости: `#speedDisplay` добавлен в цветовые HUD-селекторы.
- Добавлен перенос всего прогресса между устройствами: экспорт/импорт полного профиля (трофеи, рекорд, прокачка, эффекты, daily, история).
- В history menu добавлены кнопки: `Экспорт прогресса` и `Импорт прогресса`.
- Реализована валидация и безопасное применение импортированного состояния с обновлением UI и localStorage.
- Кнопки переноса прогресса добавлены на первый экран (main menu): `Экспорт прогресса` и `Импорт прогресса`.
- Кнопки подключены к существующей логике полного бэкапа/восстановления.
- Добавлена поддержка запуска игры напрямую как файла (`file://`), без localhost:
  - убраны module-import зависимости в index.html,
  - подключение ai.js/foodRenderer.js/backgroundRenderer.js переведено на обычные `<script src>`.
  - внешние скрипты экспортируют API через `window.SnakeAI`, `window.FoodRenderer`, `window.BackgroundRenderer`.
- По запросу возвращён режим запуска через localhost:
  - восстановлен `type=\"module\"` и import-ы в index.html,
  - восстановлены ES exports в ai.js / foodRenderer.js / backgroundRenderer.js,
  - убрана временная схема `window.*`.
- Для мобилок закреплены HUD-блоки `СЧЁТ` и `СКОРОСТЬ` сверху и в приоритете по порядку.
- `СКОРОСТЬ` больше не скрывается в compact/extreme-compact режимах.
- Добавлен отдельный профиль для телефонов в вертикальном режиме (portrait):
  - HUD закрепляется сверху как горизонтальная лента,
  - блоки `СЧЁТ` и `СКОРОСТЬ` приоритетны и всегда видимы,
  - блок управления закреплён снизу по центру,
  - canvas ужимается по высоте с учётом верхнего HUD и нижних кнопок.
- Для мобильной вертикали добавлена отдельная верхняя плашка (`mobileTopBar`) с `Счёт` и `Скорость`.
- Плашка показывается только в portrait на узких экранах и скрывается при открытом меню.
- Обновление счёта/скорости централизовано через `updateScoreDisplay()` и `updateSpeedDisplay()` с синхронизацией основного HUD и верхней плашки.
- На мобильных скрыт правый HUD (`#hud`) и добавлена верхняя плашка с `Счёт`, `Скорость` и значением ранга без слова "Ранг".
- Обновление top-rank синхронизировано с updateRank().
- Добавлен постоянный индикатор рекорда в верхнем левом углу (`cornerBest`) с синхронизацией через updateBestDisplay().
- Добавлен режим `Тренировка` на главном экране:
  - не начисляются трофеи,
  - не обновляется рекорд,
  - в истории игры помечаются как `Тренировка`, трофеи для них отображаются как `-`.
- Логика сессии расширена флагом `sessionNoRewards`.
- `cornerBest` (рекорд в левом верхнем углу) сделан mobile-only: скрыт на десктопе, отображается только при ширине <= 900px.
- Исправлен баг смертей при резком повороте: ввод игрока переведен на очередь `pendingPlayerDir`, применяется только один поворот за тик в `update()`.
- Клавиатура и тач больше не меняют `dir` напрямую; используется `queuePlayerDirection()`, что убирает двойной поворот в один физический шаг.
- В `init()/startGame()/watchReplay()` добавлен сброс очереди направления.
- Доделана группировка главного меню:
  - `Играть` раскрывает блок с режимами (обычная/тренировка/AI),
  - `Настройки` раскрывает блок (история/экспорт/импорт прогресса),
  - открытие одной группы закрывает другую.
- Добавлен `closeMainMenuGroups()` и вызовы при переходах между меню/экранами.
- Из JS удалены обработчики `exportProgressBtn/importProgressBtn`, которых больше нет в меню Истории.
- Проверка через Playwright-клиент не выполнена: в окружении отсутствуют `node` и `npx`.
- Главные группировки переведены в режим подэкранов внутри main menu:
  - при открытии `Играть` или `Настройки` скрываются все нерелевантные кнопки,
  - внизу показывается кнопка `Назад` (`mainMenuBackBtn`),
  - по `Назад` возвращается базовый вид меню.
- Реализовано через состояния `submenu-open/submenu-play/submenu-settings` + `setMainMenuGroup()`.
- Добавлена анимация трофеев после завершения игры:
  - в `gameOverMenu` добавлена строка трофеев (`gameOverTrophiesValue` + signed delta),
  - на мобилках (<=900px) анимация показывается в `gameOverMenu`,
  - на десктопе анимация крутит правый HUD-счетчик `ТРОФЕИ`.
- Добавлены функции `stopTrophyAnimation`, `setHudTrophiesValue`, `setGameOverTrophiesValue`, `animateTrophiesAfterGame`.
- Для десктопа при `game over` добавлен класс `gameover-active`, который оставляет видимым правый HUD даже при `menu-active`.
- Добавлен визуальный pop-эффект числа трофеев во время анимации начисления/списания:
  - CSS `.trophy-pop` + `@keyframes trophyPop`,
  - JS `triggerTrophyPop(isMobile)` вызывается при каждом изменении отображаемого значения.
- На мобилках пульсирует `#gameOverTrophiesValue`, на десктопе пульсирует `#trophyCount`.
- Скорость анимации трофеев сделана зависимой от величины прироста:
  - при большом `+` (delta > 20) длительность существенно увеличивается,
  - при небольших изменениях остаётся более быстрой.
- Исправлена база анимации трофеев после матча: теперь используется значение трофеев на старте забега (`sessionStartTrophies`) и итоговый net-результат за весь матч.
- Убран сценарий визуального "сначала рост, потом падение" из-за раздельного учета промежуточных изменений.
- Анимация трофеев после `game over` теперь стартует через 1 секунду (`setTimeout(..., 1000)` в `animateTrophiesAfterGame`).
- Визуальное увеличение числа сделано плавным через `transition` на `#trophyCount` и `#gameOverTrophiesValue`.
- Добавлен серверный слой для аккаунтов/облака под Netlify + Neon:
  - `package.json` с `pg`,
  - `netlify.toml` (functions + `/api/*` redirect),
  - Netlify Functions: `auth-register`, `auth-login`, `auth-me`, `progress-get`, `progress-save`,
  - утилиты `_db`, `_auth`, `_http`.
- Добавлена SQL-схема `neon-schema.sql` (таблицы `users`, `user_progress`).
- В `index.html` добавлена панель аккаунта на первом экране:
  - вход/регистрация,
  - выход,
  - ручная кнопка синхронизации.
- Реализованы автозагрузка/автосохранение прогресса в облако:
  - bootstrap по сохраненному токену,
  - загрузка cloud-прогресса после входа,
  - если cloud пустой — отправка локального прогресса в облако,
  - автосинк после game over, после импорта/сброса/импорта истории и при скрытии вкладки.
- Добавлен файл `NEON_NETLIFY_SETUP.md` с инструкциями по env и деплою.
- Вкладка аккаунта вынесена в отдельный экран:
  - в `settingsPanel` добавлена кнопка `Аккаунт` (`accountBtn`),
  - добавлено отдельное меню `accountMenu` с текущей auth-панелью,
  - добавлена кнопка `Назад` (`closeAccountMenuBtn`).
- Навигация обновлена: `accountMenu` включено в `syncMenuOverlayState()` и скрывается при переходах через `exit/menu`.
- Усилен облачный синк аккаунта до двусторонней авто-схемы (как кросс-девайс):
  - `progress-get`/`progress-save` теперь возвращают `updatedAt`,
  - клиент хранит `lastKnownCloudUpdatedAtMs` и `lastSyncedProgressJson`,
  - авто-цикл каждые 12с: сначала pull новых cloud-данных, затем push локальных изменений при необходимости,
  - при `visibilitychange` на `visible` делается мгновенный pull,
  - при `hidden` делается быстрый push,
  - при logout очищаются таймеры/интервалы синка.
- Добавлена email OTP-система:
  - backend endpoints: `auth-send-code`, `auth-verify-code`, `auth-reset-password`,
  - helper'ы: `_mailer.js` (Resend), `_otp.js`,
  - SQL: добавлена таблица `auth_codes` в `neon-schema.sql`.
- В аккаунт-меню добавлены поля/кнопки для OTP-флоу:
  - код входа,
  - вход по коду,
  - код регистрации + подтверждение регистрации,
  - код сброса + сброс пароля.
- Обновлены инструкции: требуются env `RESEND_API_KEY` и `AUTH_EMAIL_FROM`.
- По запросу отключен email OTP-флоу на фронте.
- В аккаунт-меню возвращены простые кнопки `Войти` и `Регистрация` (email+пароль), без кода из письма.
- Удалены связанные обработчики/поля OTP, чтобы не было зависимостей от почтовых переменных.
- Добавлена система никнеймов:
  - в БД `users` добавлены `nickname` и `nickname_norm` + уникальный индекс `idx_users_nickname_norm_unique`,
  - при регистрации ник обязателен,
  - логин работает по `email` или `nickname`,
  - добавлен endpoint `POST /api/auth-update-nickname` для смены ника у авторизованного пользователя,
  - `auth-me` теперь возвращает `nickname`.
- В UI аккаунта:
  - поле `Email или ник` для входа,
  - отдельное поле ника для регистрации,
  - после входа доступна смена ника (`Новый ник` + `Сменить ник`).
- Добавлена отдельная валюта `монеты` (localStorage key `coins`) с отображением в HUD/main menu/shop.
- Магазин полностью переведен на монеты:
  - цены отображаются в монетах,
  - проверка/списание идет по `coins`, а не по `trophies`.
- Ежедневные задания теперь награждают монетами:
  - тексты наград изменены на `+N монет`,
  - начисление идет в `coins`.
- Монеты добавлены в экспорт/импорт прогресса и в cloud sync snapshot.
- Сброс прогресса теперь также очищает и сбрасывает `coins`.
- Переработана система трофеев:
  - новая шкала до 2000 трофеев,
  - каждые 50 трофеев отдельная лига (`league = floor(trophies/50)`),
  - delta трофеев вычисляется от score относительно целевого `targetScore` текущей лиги.
- Добавлена награда за регистрацию: бесплатный скин еды `food-plasma`.
  - при успешной регистрации скин автоматически анлочится,
  - если был стандартный тип еды `solar`, он переключается на `plasma`.
- Добавлена новая ранговая система:
  - новый ранг каждые 50 трофеев,
  - отображение ранга теперь числом (`1..50`),
  - каждые 5 рангов меняется цвет подсветки ранга (10 цветовых tier'ов).
- Добавлены rank-награды монетами:
  - за ранги `5,10,15,...,50` выдаются монеты `5,10,15,...,50` соответственно,
  - прогресс выдачи хранится в `rankRewardClaimedRank` (localStorage + экспорт/импорт + cloud snapshot),
  - награды не выдаются повторно.
- Добавлена шкала ранга (rank progress bar):
  - в HUD блока ранга добавлены `#rankProgressTrack/#rankProgressFill/#rankProgressText`,
  - в мобильный `#mobileTopBar` добавлены `#topRankProgressTrack/#topRankProgressFill/#topRankProgressText`.
- Добавлена логика прогресса ранга `getRankProgressData()`:
  - отображение текущего прогресса внутри ранга (из 50 трофеев),
  - отображение остатка до следующего ранга,
  - режим `MAX` на 50 ранге.
- `updateRank()` теперь синхронно обновляет:
  - текст ранга,
  - цвет ранга,
  - ширину и подписи прогресс-баров (desktop + mobile).
- Node/npx в окружении отсутствуют, поэтому Playwright smoke test по skill не выполнен.
- Добавлены приватные онлайн-комнаты (вкладка "Играть") с режимом 2/2 и кодом комнаты.
- Добавлен UI комнаты (`#roomMenu`): создание/вход по коду/обновление/выход, список игроков, цель по счету, лидерские действия.
- В `playModes` добавлена кнопка `Онлайн комната`.
- В `gameOverMenu` добавлены комнатные действия: `Реванш в комнате`, `Выйти из комнаты`, текст результата по победителю.
- Добавлена серверная часть комнат (Netlify Functions + Neon):
  - `_rooms.js` (схема и helper-логика),
  - `room-create.js`, `room-join.js`, `room-state.js`, `room-leave.js`, `room-set-target.js`, `room-start.js`, `room-score.js`, `room-rematch.js`.
- Добавлены таблицы/индексы комнат в `neon-schema.sql`: `game_rooms`, `room_players`.
- Игровая интеграция:
  - комнатный матч запускается как `noRewards` (трофеи/рекорды не начисляются),
  - лидер задает цель и стартует челлендж,
  - кто первый достиг цели — победитель, статус комнаты `finished`,
  - при завершении доступны реванш или выход из комнаты.
- Добавлен поллинг состояния комнаты (1 сек), автоматический старт челленджа у обоих участников и отправка текущего/финального счета в API.
- Ограничение приватности: `room-state` доступен только участникам комнаты.
- Проверка через Node/Playwright не выполнена в этом окружении (нет `node`/`npx`).
- Фикс бага `already_in_room` после перезагрузки:
  - добавлен endpoint `room-current` для восстановления текущей комнаты пользователя,
  - добавлен helper `getUserCurrentRoomState` в `_rooms.js`,
  - `room-join` теперь при нахождении в другой активной комнате возвращает эту комнату (`reused`) вместо ошибки.
- Фронтенд теперь автоматически восстанавливает комнату:
  - после логина/регистрации,
  - при `bootstrapAccount` после reload,
  - при открытии меню комнаты,
  - при возврате на вкладку (visibilitychange) если локально roomState пуст.
- Исправлен баг отображения участников у лидера:
  - в `room-state.js` сравнение членства переведено на `Number(...)` для `userId/uid`,
  - в `index.html` все ключевые сравнения `userId` с `leaderUserId/winnerUserId/accountUser.id` переведены на числовые.
- Причина: несовпадение типов (строка vs число) ломало room-state polling у лидера после подключения второго игрока.
- Изменена логика комнатного челленджа на бесконечные попытки до достижения цели:
  - `room-score` больше не завершает комнату, когда оба игрока завершили по одной попытке,
  - комната завершается только при достижении `target_score` любым игроком.
- На `game over` в активной комнате (`status=active`) теперь доступна кнопка `Ещё попытка` (локальный перезапуск забега без реванша).
- Кнопка `Реванш в комнате` показывается только после завершения челленджа (`status=finished`).
- Расширены настройки приватной комнаты для лидера:
  - цель по счету,
  - скорость змейки (`snakeSpeed`),
  - лимит игроков (`maxPlayers`, 2..8).
- Добавлено хранение параметров комнаты в БД: `snake_speed`, `max_players`.
- Старт челленджа теперь возможен только при полном составе (`players == maxPlayers`).
- Для game over в активной комнате добавлен режим бесконечных повторных попыток (`Ещё попытка`) до определения победителя.
- Добавлен room death event:
  - бэкенд сохраняет `last_death_user_id/last_death_at`,
  - фронтенд показывает неон-тост с именем выбывшего игрока.
- В финальном меню комнаты теперь явно отображается победитель по имени.
- Исправлен join-алгоритм слотов для комнат >2: выбирается первый свободный слот, а не `count+1`.
- Обновлен `neon-schema.sql` под новые поля и ограничения комнаты.
- Фикс редактирования лидерских настроек комнаты: поллинг больше не перезаписывает `target/speed/maxPlayers`, пока соответствующий input в фокусе.
- Добавлены публичные комнаты:
  - флаг `is_public` в `game_rooms`,
  - endpoint `room-public-list` для выдачи списка открытых waiting-комнат,
  - UI списка публичных комнат во вкладке комнаты + кнопка "Войти в комнату".
- Лидер при создании/настройке комнаты теперь может выбрать "публичная комната" (isPublic).
- Обновлен `neon-schema.sql` и runtime schema migrate в `_rooms.js` для `is_public`.
